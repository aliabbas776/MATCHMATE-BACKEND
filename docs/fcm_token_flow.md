# FCM Token Flow - Where Does It Come From?

## Important Distinction

**Firebase Service Account JSON** (what you have in backend):
- Used by **backend** to authenticate with Firebase
- Allows backend to send notifications
- File: `match-mate-cb4e2-firebase-adminsdk-fbsvc-38a701b9e7.json`

**FCM Token** (what you need from mobile app):
- Generated by Firebase SDK on **mobile device**
- Unique identifier for each device
- Must be sent from mobile app to backend
- Stored in backend database (Device model)

## How It Works

```
┌─────────────────┐         ┌──────────────────┐         ┌─────────────────┐
│   Mobile App    │         │   Backend API    │         │   Firebase      │
│  (React Native) │         │    (Django)      │         │   Cloud         │
└─────────────────┘         └──────────────────┘         └─────────────────┘
       │                            │                            │
       │  1. App starts             │                            │
       │  2. Firebase SDK           │                            │
       │     requests token          │                            │
       ├───────────────────────────>│                            │
       │                            │                            │
       │                            │                            │
       │  3. Firebase generates     │                            │
       │     unique FCM token        │                            │
       │<───────────────────────────┼───────────────────────────>│
       │                            │                            │
       │  4. Token received         │                            │
       │     (e.g., "abc123...")     │                            │
       │                            │                            │
       │  5. Send token to backend   │                            │
       │     POST /api/devices/      │                            │
       │     register/               │                            │
       ├───────────────────────────>│                            │
       │                            │                            │
       │                            │  6. Store token in DB      │
       │                            │     (Device model)          │
       │                            │                            │
       │  7. Token stored            │                            │
       │<───────────────────────────│                            │
       │                            │                            │
       │                            │  8. Backend sends          │
       │                            │     notification using      │
       │                            │     stored token            │
       │                            ├───────────────────────────>│
       │                            │                            │
       │  9. Notification received  │                            │
       │<───────────────────────────┼───────────────────────────│
       │                            │                            │
```

## React Native Code Example

Here's how to get the FCM token in your React Native app and send it to the backend:

### 1. Install React Native Firebase

```bash
npm install @react-native-firebase/app @react-native-firebase/messaging
```

### 2. Get FCM Token and Register with Backend

```javascript
import messaging from '@react-native-firebase/messaging';
import { Platform } from 'react-native';

async function registerDeviceToken(userToken) {
  try {
    // Request permission for iOS
    if (Platform.OS === 'ios') {
      const authStatus = await messaging().requestPermission();
      const enabled =
        authStatus === messaging.AuthorizationStatus.AUTHORIZED ||
        authStatus === messaging.AuthorizationStatus.PROVISIONAL;
      
      if (!enabled) {
        console.log('Permission not granted');
        return;
      }
    }

    // Get FCM token from Firebase
    const fcmToken = await messaging().getToken();
    console.log('FCM Token:', fcmToken);

    // Send token to your backend
    const response = await fetch('http://your-backend-url/api/devices/register/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${userToken}`, // Your JWT token
      },
      body: JSON.stringify({
        fcm_token: fcmToken,
        device_type: Platform.OS === 'ios' ? 'ios' : 'android',
      }),
    });

    const data = await response.json();
    console.log('Device registered:', data);
    
    return fcmToken;
  } catch (error) {
    console.error('Error registering device:', error);
  }
}

// Call this when user logs in or app starts
registerDeviceToken(userJWTToken);
```

### 3. Handle Token Refresh

FCM tokens can change, so you need to listen for token refresh:

```javascript
import messaging from '@react-native-firebase/messaging';

// Listen for token refresh
messaging().onTokenRefresh(async (newToken) => {
  console.log('New FCM token:', newToken);
  
  // Re-register with backend
  await registerDeviceToken(userJWTToken);
});
```

### 4. Handle Background Notifications

```javascript
import messaging from '@react-native-firebase/messaging';

// Handle background messages
messaging().setBackgroundMessageHandler(async remoteMessage => {
  console.log('Background message:', remoteMessage);
});

// Handle foreground messages
messaging().onMessage(async remoteMessage => {
  console.log('Foreground message:', remoteMessage);
  // Show notification in your app
});
```

## Backend API Endpoint

Your backend already has the endpoint ready:

**POST** `/api/devices/register/`

**Headers:**
```
Authorization: Bearer YOUR_JWT_TOKEN
Content-Type: application/json
```

**Body:**
```json
{
  "fcm_token": "abc123xyz789...",  // This comes from mobile app
  "device_type": "android"  // or "ios"
}
```

**Response:**
```json
{
  "message": "Device registered successfully.",
  "device": {
    "id": 1,
    "fcm_token": "abc123xyz789...",
    "device_type": "android",
    "is_active": true,
    "created_at": "2024-01-01T12:00:00Z",
    "updated_at": "2024-01-01T12:00:00Z"
  }
}
```

## Where to Find FCM Token

### In React Native App:
- Generated by Firebase SDK: `await messaging().getToken()`
- Usually a long string like: `"cXyZ123abc...very-long-token-string..."`
- Different for each device
- Can change (so listen for refresh)

### In Backend Database:
After registration, you can see stored tokens:

```python
# Django shell
from matching_app.models import Device

# List all devices
devices = Device.objects.filter(is_active=True)
for device in devices:
    print(f"User: {device.user.username}")
    print(f"Token: {device.fcm_token}")
    print(f"Type: {device.device_type}")
```

## Summary

1. **FCM Token Source**: Generated by Firebase SDK on mobile device
2. **Backend Role**: Receives and stores the token via API
3. **Flow**: Mobile app gets token → Sends to backend → Backend stores it → Backend uses it to send notifications
4. **Your Firebase JSON File**: Used by backend to authenticate with Firebase (different from FCM token)

The FCM token is **NOT** in your backend code - it comes from the mobile app and gets stored in your database after registration!

